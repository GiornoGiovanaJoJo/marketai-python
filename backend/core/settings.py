"""\nDjango settings for MarketAI project.\nGenerated for Django 5.1\n"""\n\nfrom pathlib import Path\nimport os\nimport environ\nfrom datetime import timedelta\n\n# Build paths inside the project\nBASE_DIR = Path(__file__).resolve().parent.parent\n\n# Initialize environment variables\nenv = environ.Env(\n    DEBUG=(bool, False)\n)\n\n# Read .env file\nenviron.Env.read_env(os.path.join(BASE_DIR.parent, '.env'))\n\n# SECURITY WARNING: keep the secret key used in production secret!\nSECRET_KEY = env('DJANGO_SECRET_KEY', default='django-insecure-change-me-in-production')\n\n# SECURITY WARNING: don't run with debug turned on in production!\nDEBUG = env('DJANGO_DEBUG', default=True)\n\nALLOWED_HOSTS = env.list('DJANGO_ALLOWED_HOSTS', default=['localhost', '127.0.0.1'])\n\n# Field Encryption Key (for encrypting sensitive data like API keys, tokens)\n# Generate with: python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"\nFIELD_ENCRYPTION_KEY = env('FIELD_ENCRYPTION_KEY', default=None)\n\n# Application definition\nINSTALLED_APPS = [\n    'django.contrib.admin',\n    'django.contrib.auth',\n    'django.contrib.contenttypes',\n    'django.contrib.sessions',\n    'django.contrib.messages',\n    'django.contrib.staticfiles',\n    \n    # Third party apps\n    'rest_framework',\n    'rest_framework_simplejwt',\n    'corsheaders',\n    'drf_spectacular',\n    'django_celery_beat',\n    'django_celery_results',\n    \n    # Local apps\n    'apps.authentication',\n    'apps.users',\n    'apps.campaigns',\n    'apps.statistics',\n    'apps.integrations',\n]\n\nMIDDLEWARE = [\n    'django.middleware.security.SecurityMiddleware',\n    'whitenoise.middleware.WhiteNoiseMiddleware',\n    'corsheaders.middleware.CorsMiddleware',\n    'django.contrib.sessions.middleware.SessionMiddleware',\n    'django.middleware.common.CommonMiddleware',\n    'django.middleware.csrf.CsrfViewMiddleware',\n    'django.contrib.auth.middleware.AuthenticationMiddleware',\n    'django.contrib.messages.middleware.MessageMiddleware',\n    'django.middleware.clickjacking.XFrameOptionsMiddleware',\n]\n\nROOT_URLCONF = 'core.urls'\n\nTEMPLATES = [\n    {\n        'BACKEND': 'django.template.backends.django.DjangoTemplates',\n        'DIRS': [BASE_DIR / 'templates'],\n        'APP_DIRS': True,\n        'OPTIONS': {\n            'context_processors': [\n                'django.template.context_processors.debug',\n                'django.template.context_processors.request',\n                'django.contrib.auth.context_processors.auth',\n                'django.contrib.messages.context_processors.messages',\n            ],\n        },\n    },\n]\n\nWSGI_APPLICATION = 'core.wsgi.application'\n\n# Database\n# https://docs.djangoproject.com/en/5.1/ref/settings/#databases\n\nDATABASES = {\n    'default': {\n        'ENGINE': 'django.db.backends.postgresql',\n        'NAME': env('DB_NAME', default='marketai'),\n        'USER': env('DB_USER', default='marketai'),\n        'PASSWORD': env('DB_PASSWORD', default='marketai'),\n        'HOST': env('DB_HOST', default='postgres'),  # Docker container name\n        'PORT': env('DB_PORT', default='5432'),\n    }\n}\n\n# Custom User Model\nAUTH_USER_MODEL = 'users.User'\n\n# Password validation\nAUTH_PASSWORD_VALIDATORS = [\n    {'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator'},\n    {'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator'},\n    {'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator'},\n    {'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator'},\n]\n\n# Internationalization\nLANGUAGE_CODE = 'ru-ru'\nTIME_ZONE = 'Europe/Moscow'\nUSE_I18N = True\nUSE_TZ = True\n\n# Static files (CSS, JavaScript, Images)\nSTATIC_URL = '/static/'\nSTATIC_ROOT = BASE_DIR / 'staticfiles'\nSTATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'\n\n# Media files\nMEDIA_URL = '/media/'\nMEDIA_ROOT = BASE_DIR / 'media'\n\n# Default primary key field type\nDEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'\n\n# REST Framework configuration\nREST_FRAMEWORK = {\n    'DEFAULT_AUTHENTICATION_CLASSES': (\n        'rest_framework_simplejwt.authentication.JWTAuthentication',\n    ),\n    'DEFAULT_PERMISSION_CLASSES': (\n        'rest_framework.permissions.IsAuthenticated',\n    ),\n    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',\n    'PAGE_SIZE': 20,\n    'DEFAULT_FILTER_BACKENDS': (\n        'rest_framework.filters.SearchFilter',\n        'rest_framework.filters.OrderingFilter',\n    ),\n    'DEFAULT_SCHEMA_CLASS': 'drf_spectacular.openapi.AutoSchema',\n    'DEFAULT_RENDERER_CLASSES': (\n        'rest_framework.renderers.JSONRenderer',\n    ),\n    'DEFAULT_PARSER_CLASSES': (\n        'rest_framework.parsers.JSONParser',\n        'rest_framework.parsers.FormParser',\n        'rest_framework.parsers.MultiPartParser',\n    ),\n    'EXCEPTION_HANDLER': 'core.exceptions.custom_exception_handler',\n}\n\n# JWT configuration\nSIMPLE_JWT = {\n    'ACCESS_TOKEN_LIFETIME': timedelta(minutes=env.int('JWT_ACCESS_TOKEN_LIFETIME', default=60)),\n    'REFRESH_TOKEN_LIFETIME': timedelta(minutes=env.int('JWT_REFRESH_TOKEN_LIFETIME', default=1440)),\n    'ROTATE_REFRESH_TOKENS': True,\n    'BLACKLIST_AFTER_ROTATION': True,\n    'ALGORITHM': 'HS256',\n    'SIGNING_KEY': env('JWT_SECRET_KEY', default=SECRET_KEY),\n    'VERIFYING_KEY': None,\n    'AUTH_HEADER_TYPES': ('Bearer',),\n    'USER_ID_FIELD': 'id',\n    'USER_ID_CLAIM': 'user_id',\n    'AUTH_TOKEN_CLASSES': ('rest_framework_simplejwt.tokens.AccessToken',),\n    'TOKEN_TYPE_CLAIM': 'token_type',\n}\n\n# CORS configuration\nCORS_ALLOWED_ORIGINS = env.list(\n    'DJANGO_CORS_ALLOWED_ORIGINS',\n    default=['http://localhost:5173', 'http://127.0.0.1:5173', 'http://localhost:3000']\n)\nCORS_ALLOW_CREDENTIALS = True\n\n# Redis configuration (use container names for Docker)\nREDIS_URL = env('REDIS_URL', default='redis://redis:6379/0')\n\nCACHES = {\n    'default': {\n        'BACKEND': 'django_redis.cache.RedisCache',\n        'LOCATION': env('CACHE_REDIS_URL', default='redis://redis:6379/1'),\n        'OPTIONS': {\n            'CLIENT_CLASS': 'django_redis.client.DefaultClient',\n        },\n        'KEY_PREFIX': 'marketai',\n        'TIMEOUT': 300,\n    }\n}\n\n# Celery configuration (use container names for Docker)\nCELERY_BROKER_URL = env('CELERY_BROKER_URL', default='redis://redis:6379/2')\nCELERY_RESULT_BACKEND = 'django-db'\nCELERY_CACHE_BACKEND = 'default'\nCELERY_ACCEPT_CONTENT = ['json']\nCELERY_TASK_SERIALIZER = 'json'\nCELERY_RESULT_SERIALIZER = 'json'\nCELERY_TIMEZONE = TIME_ZONE\nCELERY_TASK_TRACK_STARTED = True\nCELERY_TASK_TIME_LIMIT = 30 * 60  # 30 minutes\nCELERY_TASK_ALWAYS_EAGER = env.bool('CELERY_TASK_ALWAYS_EAGER', default=False)\nCELERY_BROKER_CONNECTION_RETRY_ON_STARTUP = True\n\n# DRF Spectacular (API Documentation)\nSPECTACULAR_SETTINGS = {\n    'TITLE': 'MarketAI API',\n    'DESCRIPTION': 'АPI для управления рекламными кампаниями на маркетплейсах',\n    'VERSION': '1.0.0',\n    'SERVE_INCLUDE_SCHEMA': False,\n    'COMPONENT_SPLIT_REQUEST': True,\n    'SCHEMA_PATH_PREFIX': r'/api/v[0-9]',\n}\n\n# Email configuration\nEMAIL_BACKEND = env('EMAIL_BACKEND', default='django.core.mail.backends.console.EmailBackend')\nEMAIL_HOST = env('EMAIL_HOST', default='localhost')\nEMAIL_PORT = env.int('EMAIL_PORT', default=587)\nEMAIL_USE_TLS = env.bool('EMAIL_USE_TLS', default=True)\nEMAIL_HOST_USER = env('EMAIL_HOST_USER', default='')\nEMAIL_HOST_PASSWORD = env('EMAIL_HOST_PASSWORD', default='')\n\n# Wildberries API\nWILDBERRIES_API_KEY = env('WILDBERRIES_API_KEY', default='')\nWILDBERRIES_API_URL = env('WILDBERRIES_API_URL', default='https://suppliers-api.wildberries.ru')\n\n# DuckDB Analytics\nDUCKDB_PATH = env('DUCKDB_PATH', default=str(BASE_DIR / 'data' / 'analytics.duckdb'))\n\n# Logging\nLOGGING = {\n    'version': 1,\n    'disable_existing_loggers': False,\n    'formatters': {\n        'verbose': {\n            'format': '{levelname} {asctime} {module} {message}',\n            'style': '{',\n        },\n    },\n    'handlers': {\n        'console': {\n            'class': 'logging.StreamHandler',\n            'formatter': 'verbose',\n        },\n        'file': {\n            'class': 'logging.FileHandler',\n            'filename': BASE_DIR / 'logs' / 'django.log',\n            'formatter': 'verbose',\n        },\n    },\n    'root': {\n        'handlers': ['console'],\n        'level': 'INFO',\n    },\n    'loggers': {\n        'django': {\n            'handlers': ['console'],\n            'level': 'INFO',\n            'propagate': False,\n        },\n        'apps': {\n            'handlers': ['console', 'file'],\n            'level': 'DEBUG' if DEBUG else 'INFO',\n            'propagate': False,\n        },\n    },\n}\n\n# Security settings for production\nif not DEBUG:\n    SECURE_SSL_REDIRECT = True\n    SESSION_COOKIE_SECURE = True\n    CSRF_COOKIE_SECURE = True\n    SECURE_BROWSER_XSS_FILTER = True\n    SECURE_CONTENT_TYPE_NOSNIFF = True\n    X_FRAME_OPTIONS = 'DENY'\n